# .github/workflows/ci-cd.yml
name: InvestMateAI CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ§ª Testing Job
  test:
    name: Tests & Security
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Run tests
      env:
        DATABASE_URL: "sqlite:///:memory:"
        SECRET_KEY: test_secret_key_for_ci
        OPENAI_API_KEY: sk-test-key-for-ci-environment-only
        AWS_S3_BUCKET_NAME: test-bucket
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        PYTHONPATH: /home/runner/work/InvestMateAI/InvestMateAI
      run: |
        # Add current directory to Python path
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"

        # Create database tables directly from models (skip migrations for CI)
        python -c "
        import sys
        sys.path.append('.')
        from app.database import Base, engine
        Base.metadata.create_all(bind=engine)
        print('âœ… Database tables created successfully')
        "

        # Run tests with proper Python path
        PYTHONPATH=. pytest app/tests/ -v --tb=short

    - name: ğŸ” Security check
      run: |
        pip install safety bandit
        safety check -r requirements.txt --ignore 70612 || echo "âš ï¸ Safety check completed with warnings"
        bandit -r app/ -ll || echo "âš ï¸ Bandit scan completed"

    - name: ğŸ§¹ Code style check
      run: |
        pip install flake8
        flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "âš ï¸ Style check completed"

  # ğŸ—ï¸ Build Docker image
  build:
    name: Build Docker
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event_name == 'push' }}

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Build Docker image
      run: |
        docker build -t investmate-ai:latest .
        echo "âœ… Docker build completed successfully"

